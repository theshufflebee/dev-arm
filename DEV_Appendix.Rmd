---
title: "Appendix"
output: 
  pdf_document:
    toc: true
    fig_caption: yes
    toc_depth: 3
    number_sections: true
header-includes:
   - \usepackage{booktabs}
   - \setcounter{secnumdepth}{3}
   - \usepackage{float}
   - \usepackage{placeins}
---
\newpage


```{r library_setup, message=FALSE, warning=FALSE, include=FALSE, results=FALSE}
rm(list=ls())
require(tinytex) #LaTeX
require(ggplot2) #plots
require(haven) #load data
require(dplyr) #data management
require(lubridate) #data dates management
require(zoo) #for lagging
require(jtools) #tables
require(huxtable) #tables
require(lmtest) #reg tests
require(data.table) #for data filtering
require(sandwich) #regression errors
require(readxl) #for reading excel data
require(tidyr) #data
require(tidyverse) #data
require(fixest) #TWFE regression
require(purrr) #for looping plots
options(scipen=999)

latex_format = TRUE

getwd()
setwd("...") 
set.seed(123)

```

# Data 

```{r data, include=FALSE}

load("final_data.Rdata")
load("final_data_quartiles.Rdata")
load("final_data_deciles.Rdata")
load("final_data_household.Rdata")

```

## Detailed Explanation

We have district-level panel data for the 11 districts (Merz) of Armenia from the
years 2004 to 2023. It consists of variables from aggregated household surveys,
variables on detailed agricultural output and drought-related variables. Every
variable represents the average level in a particular year in a particular district.

### Variable Names \& Units
* In Armenian Dram (currency):
  + income: Household income
  + agric_income: Household agriculture income
  + fdcons: Household food consumption
  + fdpurch: Household food purchases
  + exp: Household expenditures 
* In Percentage:
  + poverty: Rate of households in poverty
  + urban: Rate of households living in an urban area
  + share: Share of observations of SPEI above +1
  + agric_stress: Percentage of arable areas with a VHI (Vegetable Health Index) 
                  value below 35\%
* Dummies:
  + drought_dummy1: Equals 1 if there are at least 10 SPEI observations above +1
  + drought_dummy2: Equals 1 if there are at least 15 SPEI observations above +1
* Tons (1000kg)
  + agric_output: Gross Agriculture output
  + grains_harvest: Tons of grains and leguminous plants harvested
  + vegetables_harvest: Tons of vegetables harvested
  + fruits_harvest: Tons of fruits and berries harvested
  + potatoes_harvest: Tons of potatoes harvested
  + watermelon_harvest: Tons of watermelons harvested
  + grapes_harvest: Tons of grapes harvested
* Hectare (1000km2)
  + grains_area: Hectares used for harvesting grains and leguminous plants
  + vegetables_area: Hectares used for harvesting vegetables
  + fruits_area: Hectares used for harvesting fruits and berries
  + potatoes_area: Hectares used for harvesting potatoes
  + watermelon_area: Hectares used for harvesting watermelons
  + grapes_area: Hectares used for harvesting grapes
* Tons per hectare (1000kg / 1000km2)
  + output_per_field_grains: Grains harvested divided by area (yield)
  + output_per_field_vegetables: Vegetables harvested divided by area (yield)
  + output_per_field_fruits: Fruits harvested divided by area (yield)
  + output_per_field_potatoes: Potatoes harvested divided by area (yield)
  + output_per_field_grapes: Grapes harvested divided by area (yield)
* Other:
  + spei: SPEI measures deviation of the water balance from the long term mean.
          A value of 0 means we are at the long term mean, while +1 is a moderate
          drought that happens once or twice in 10 years. Note that we took the 
          official SPEI and multiplied it by (-1) in order to adjust the coefficient
          sign interpretation in the regressions. Positive values indicate harsher conditions.
  + temperature: CRU land-based measure of average surface temperature in celsius
  

## Detailed Explaination for SPEI & Stress

The Standardized Precipitation-Evapotranspiration Index is a multiscalar drought index that allows a comparison with respect to normal long term conditions. It's value is a Standard Normal Distribution with sd =1. A value of -0.8 to -1.2 should occur arround once or twice in 10 years. It can be calculated over multiple durations. Here we use the SPEI-3 which represents the water balance over the last 3 months.

We use data from the Global Drought Observatory to calculate our values. The standard way of expressing it is geospatial data with pixels corresponding to certain coordinates. Then we use the District polygons of Armenias Merz to select all SPEI pixels touched by the district and average them out to calculate the value of the district. As the SPEI is recalculated every 10 days we then transform these values into different indicators.

First we average out per year and district to get the value mean SPEI. This tells us the average deviation from the long term 3 month waterbalance per year.

Further we create two dummies. SPEI consec is equal to 1 if there were at least 10 observations in a row with an SPEI value below -1. which would correspond to a 90 day period where the water balance was in moderate drought conditions.

A second dummy is equal to 1 if there are 15 observations below -1 in a year. They do not have to be consecutive. 

Agricultural Stress is based on the VHI index. It is based on meteorological satellite data. It can detect plants that wilt or show unusual colors and drops the index if it is the case. The VHI gives the percentage of observation that have a VHI below 35%.

## Descriptive Evidence

\FloatBarrier

### Raw Data Graphs
```{r district desc ev, echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H", fig.height=4.32}

var_names <- c(
  "income"                  = "Household Income",
  "agric_income"            = "Household Agricultural Income",
  "agric_output"            = "Gross Agricultural Output",
  "fdcons"                  = "Household food Consumption",
  "poverty"                 = "Rate of households in poverty",
  "urban"                   = "Rate of households in urban areas",
  "spei"                    = "SPEI (Drought Index)",
  "share"                   = "Share of observations of SPEI above +1",
  "agric_stress"            = "Agricultural Stress",
  "Total_Rainfall"          = "Total Rainfall",
  "output_per_field_fruits" = "Fruits Yield",
  "output_per_field_grains" = "Grains Yield",
  "output_per_field_vegetables" = "Vegetables Yield",
  "output_per_field_potatoes"   = "Potatoes Yield",
  "grains_harvest"          = "Grains Harvest",
  "vegetables_harvest"      = "Vegetables Harvest",
  "fruits_harvest"          = "Fruits Harvest",
  "potatoes_harvest"        = "Potatoes Harvest",
  "temperature" = "Temperature (C)",
  "district" = "District",
  "year" = "Year")

plot_data <- dataset %>%
  pivot_longer(cols = c(income, agric_income, agric_output, fdcons, poverty,
                        spei, share, agric_stress, Total_Rainfall, 
                        output_per_field_fruits,output_per_field_grains), 
    names_to = "metric",    
    values_to = "value" )

all_metrics <- unique(plot_data$metric)

plot_list_by_metric <- map(all_metrics, function(met) {
  pretty_name <- var_names[met]
  plot_data <- plot_data %>%
    filter(metric == met)
  p <- ggplot(plot_data, aes(x = year, y = value)) +
    geom_line() +
    geom_point(size = 0.5) +
    facet_wrap(~ district, scales = "free_y", ncol = 3) + 
    labs(title = paste("Evolution of:", pretty_name),x = "Year",y = "Value") +
    theme_light() + 
    theme(plot.title = element_text(face = "bold", size = 12, hjust = 0.5), 
          plot.subtitle = element_text(size = 12, hjust = 0.5), 
          plot.caption = element_text(color = "grey50", face = "italic"),
          strip.text = element_text(face = "bold", color = "black", hjust = 0), 
          strip.background = element_rect(fill = "grey90", color = NA), 
          axis.title = element_text(size = 11), 
          axis.text.x = element_text(angle = 45, hjust = 1, size = 9), 
          axis.text.y = element_text(size = 9),
          panel.grid.minor = element_blank() )
    print(p)
  return(p) } )

```



### Graphs with Drought Dummy

```{r district desc ev agric drought, echo=FALSE, message=FALSE, warning=FALSE}

# Compute, for each years, the mean of agricultural output between districts
#  that experience drought vs no drought
agric_plot <- dataset %>%
  group_by(year, drought_dummy) %>%
  summarise(mean_agric = mean(agric_output, na.rm = TRUE), n_district = n()) 

ggplot(agric_plot, aes(x = year, y = mean_agric,
                      color = factor(drought_dummy), group = factor(drought_dummy))) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_color_manual(values = c("0" = "#0072B2", "1" = "#D55E00"),
                     labels = c("No Drought", "Drought")) +
  labs(x = "Year", y = "Mean Agricultural Output", color = "Drought Status",
       title = "Impact of Drought on Agricultural Output",
       caption= "Note: This graph should be interpreted with caution as the number of districts is very low, meaning that any kind of visible relationship is very likely due to confounding effects and between-district variation.") +
  theme_minimal() +
  theme(legend.position = "top",
    axis.text.x = element_text(size = 5),
    axis.text.y = element_text(size = 5),
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 4, face = "bold"),
    plot.caption = element_text(hjust = 0, face = "italic", size = 6))

```

### Graphs with Drought Dummy and Quartiles
```{r district desc ev w/ quartiles, echo=FALSE, message=FALSE, warning=FALSE}

# Data Prep
dataset_prepped_q <- dataset_quartiles %>%
  mutate(drought_status = factor(drought_dummy, 
                            levels = c(0, 1), 
                            labels = c("No Drought Event", "Drought Event")),
         income_quartile = factor(national_quartile, 
                            levels = c(1, 2, 3, 4), 
                            labels = c("Q1 (Poorest)", "Q2", "Q3", "Q4 (Richest)")))

# A1. Aggregate the data: Find the mean income for each year and quartile
plot1_data_q <- dataset_prepped_q %>%
  group_by(year, income_quartile) %>%
  summarize(avg_income = mean(income, na.rm = TRUE),
            avg_agr_income = mean(agric_income, na.rm = TRUE), .groups = 'drop') 


# A2. Create the plot q
ggplot(plot1_data_q, aes(x = year, y = avg_income, color = income_quartile, group = income_quartile)) +
  geom_line(linewidth = 1.2, alpha = 0.8) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) + 
  scale_color_brewer(palette = "RdYlBu", direction = -1) + 
  labs(title = "Average Income by Income Quartile Over Time",
        subtitle = "Averaged across all districts",
        x = "Year",
        y = "Average Annual Income",
        color = "Income Quartile") +
  theme_minimal() + theme(legend.position = "bottom",
    axis.text.x = element_text(size = 5),
    axis.text.y = element_text(size = 5),
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 4, face = "bold"))


# B1. Aggregate data: Mean income by year, quartile, AND drought status
plot2_data_q <- dataset_prepped_q %>%
  group_by(year, income_quartile, drought_status) %>%  
  summarize(avg_income = mean(income, na.rm = TRUE),
            avg_agr_income = mean(agric_income, na.rm = TRUE), .groups = 'drop')


# B2. Create the faceted plot q
ggplot(plot2_data_q, aes(x = year, y = avg_income, color = drought_status, group = drought_status)) +
  geom_line(linewidth = 1.1, alpha = 0.9) +
  # Create 4 separate plots, one for each 'income_quartile'
  facet_wrap(~ income_quartile, scales = "free_y") +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("No Drought Event" = "#0072B2", "Drought Event" = "#D55E00")) +
  labs(title = "Impact of Drought Events on Income, by Income Quartile",
        subtitle = "Average income trends faceted by income group",
        x = "Year",
        y = "Average Annual Income",
        color = "Drought Status") +
  theme_bw() + 
  theme(legend.position = "top",
        axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        plot.title = element_text(size = 14, face = "bold"),
        strip.background = element_rect(fill = "grey90"), 
        strip.text = element_text(face = "bold") )

```

\newpage

# TWFE Regressions

## Data

### Variable Units

* Armenian Dram (currency):
  + Income
  + Agriculture income
  + Food consumption
* Tons (1000kg)
  + Agriculture output
  + Grains harvest
  + Vegetables harvest
  + Fruits harvest
  + Potatoes harvest
* Tons per hectare (1000kg / 1000km2)
  + Grains output per field
  + Vegetables output per field
  + Fruits output per field
  + Potatoes output per field


```{r tfwedata selection, echo=FALSE, message=FALSE, warning=FALSE}

# Select TRUE for having dependent variables in logs
dependent_in_logs <- TRUE

# Select TRUE to exclude "Yerevan" district from analysis
exclude_yerevan <- FALSE

# Select TRUE to focus on, on average, more rural districts
more_rural <- FALSE

# Select TRUE to focus on, on average, districts with more poverty
more_poverty <- FALSE

# Select TRUE to have up to 10 lags for all independent variables 
more_lags <- FALSE

```

```{r selection implementation, echo=FALSE, message=FALSE, warning=FALSE}

# Base case
twfe_data = dataset

# Dependent variables
dependent_vars <- c("income", "agric_income", "agric_output", "fdcons",
                    "grains_harvest", "vegetables_harvest", "fruits_harvest",
                    "potatoes_harvest", "output_per_field_grains", 
                    "output_per_field_vegetables", "output_per_field_fruits",
                    "output_per_field_potatoes")

# Logs implementation
if (dependent_in_logs) {
  for (col in dependent_vars) {
    twfe_data[[col]] <- log(twfe_data[[col]]) }
  cat("Dependent variables are in logs.") } 

# Excluding Yerevan implementation
if (exclude_yerevan) {
  twfe_data = subset(twfe_data, district != "Yerevan") 
  cat("Excluding Yerevan district from sample.") }

# Selecting majority-rural districts implementation
if (more_rural) {
  twfe_data = subset(twfe_data, urban < 0.5) 
  cat("Focusing on districts with higher rural population, on average.")}

# Selecting poorer regions implementation
if (more_poverty) {
  twfe_data = subset(twfe_data, poverty > 0.3) 
  cat("Focusing on districts with higher rates of poverty, on average.") }

# Selecting a certain timeframe
#twfe_data = subset(twfe_data, year > 2015)

# Selecting the poorest income decile
#twfe_data = subset(dataset_deciles, national_decile == 1)

# Selecting the poorest income quartile
#twfe_data = subset(dataset_quartiles, national_quartile == 1)

```


## Regressions

### Equation
All our regressions resemble the following equations, where $Y_{dt}$ represents
the chosen outcome variable for district $d$ at time $t$, $\lambda_d$ represents
the district-specific fixed effect, $\gamma_t$ represents the time-specific 
fixed effect, $X_{dt}$ is the chosen explanatory variable, $\beta$ is the effect
of said variable on the outcome, and $\epsilon_{dt}$ is the error.
$$
\begin{aligned}
  Y_{dt} &= \alpha + \lambda_d + \gamma_t + \beta X_{dt} + \epsilon_{dt}
\end{aligned}
$$
$$
\begin{aligned}
  Y_{dt} &= \alpha + \lambda_d + \gamma_t + \beta_1 X_{dt} + \beta_2 X_{d,t-1} + \epsilon_{dt}
\end{aligned}
$$
$$
\begin{aligned}
  Y_{dt} &= \alpha + \lambda_d + \gamma_t + \beta_1 X_{dt} + \beta_2 X_{d,t-1} 
  + \beta_3 X_{d,t-2}  + \epsilon_{dt}
\end{aligned}
$$


```{r reg_loop, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Define independent variables as a list of groups
if (more_lags) {
  iv_groups <- list(
    "SPEI" = c(
      "spei",
      "spei + spei_lag1",
      "spei + spei_lag1 + spei_lag2",
      "spei + spei_lag1 + spei_lag2 + spei_lag3",
      "spei + spei_lag1 + spei_lag2 + spei_lag3 + spei_lag4",
      "spei + spei_lag1 + spei_lag2 + spei_lag3 + spei_lag4 + spei_lag5",
      "spei + spei_lag1 + spei_lag2 + spei_lag3 + spei_lag4 + spei_lag5 + spei_lag6"),
    "Share" = c(
      "share",
      "share + share_lag1",
      "share + share_lag1 + share_lag2",
      "share + share_lag1 + share_lag2 + share_lag3",
      "share + share_lag1 + share_lag2 + share_lag3 + share_lag4",
      "share + share_lag1 + share_lag2 + share_lag3 + share_lag4 + share_lag5",
      "share + share_lag1 + share_lag2 + share_lag3 + share_lag4 + share_lag5 + share_lag6"),
    "AgricStress" = c(
      "agric_stress",
      "agric_stress + agric_stress_lag1",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2 + agric_stress_lag3",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2 + agric_stress_lag3 +
        agric_stress_lag4",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2 + agric_stress_lag3 +
        agric_stress_lag4 + agric_stress_lag5",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2 + agric_stress_lag3 +
        agric_stress_lag4 + agric_stress_lag5 + agric_stress_lag6"),
     "Temperature" = c(
       "temperature",
       "temperature + temperature_lag1",
       "temperature + temperature_lag1 + temperature_lag2",
       "temperature + temperature_lag1 + temperature_lag2 + temperature_lag3",
       "temperature + temperature_lag1 + temperature_lag2 + temperature_lag3 +
         temperature_lag4",
       "temperature + temperature_lag1 + temperature_lag2 + temperature_lag3 +
         temperature_lag4 + temperature_lag5",
       "temperature + temperature_lag1 + temperature_lag2 + temperature_lag3 +
         temperature_lag4 + temperature_lag5 + temperature_lag6") ) 
  model_names <- c(
  "Model 1: 0 Lags",
  "Model 2: 1 Lag",
  "Model 3: 2 Lags",
  "Model 4: 3 Lags",
  "Model 5: 4 Lags",
  "Model 6: 5 Lags",
  "Model 7: 6 Lags")
} else {
  iv_groups <- list(
    "SPEI" = c(
      "spei",
      "spei + spei_lag1",
      "spei + spei_lag1 + spei_lag2"),
    "Share" = c(
      "share",
      "share + share_lag1",
      "share + share_lag1 + share_lag2"),
    "AgricStress" = c(
      "agric_stress",
      "agric_stress + agric_stress_lag1",
      "agric_stress + agric_stress_lag1 + agric_stress_lag2"),
    "Temperature" = c(
       "temperature",
       "temperature + temperature_lag1",
       "temperature + temperature_lag1 + temperature_lag2") ) 
  model_names <- c(
  "Model 1: 0 Lags",
  "Model 2: 1 Lag",
  "Model 3: 2 Lags") }

# Pretty names
create_lag_labels <- function(base_code, base_pretty, n_lags = 6) {
  labels <- setNames(base_pretty, base_code)
  for (i in 1:n_lags) {
    code <- paste0(base_code, "_lag", i)
    pretty <- paste0(base_pretty, " (Lag ", i, ")")
    labels[code] <- pretty}
  return(labels)}

var_dict <- c(
  var_names, 
  "AgricStress" = "Agricultural Stress",
  "Share"       = "Share of observations of SPEI above +1",
  "SPEI"        = "Drought Index (SPEI)",
  "Temperature" = "Temperature",
  create_lag_labels("spei", "SPEI"),
  create_lag_labels("share", "SPEI Share"),
  create_lag_labels("agric_stress", "Agric. Stress"),
  create_lag_labels("temperature", "Temp."))

# Loop for each dependent variable for each group of independent variables
for (dv in dependent_vars) {
  
  # Create a latex version of the dv name 
  pretty_dv <- var_dict[dv]
  if (is.na(pretty_dv)) pretty_dv <- dv
  cat(paste0("\n\n\\subsection{Dependent Variable: ", pretty_dv, "}\n\n"))

  for (group_name in names(iv_groups)) {
    pretty_group <- var_dict[group_name]
    if (is.na(pretty_group)) pretty_group <- group_name
    cat(paste0("\n\n\\subsubsection{Regressed on: ", pretty_group, "}\n\n"))
    models_list <- list() 
    current_iv_formulas <- iv_groups[[group_name]] 
    
    for (i in 1:length(current_iv_formulas)) {
          fml_string <- sprintf("%s ~ %s | district + year", 
                            dv, 
                            current_iv_formulas[i])
      models_list[[i]] <- feols(
        as.formula(fml_string),
        data = twfe_data,
        cluster = ~ district) }
      names(models_list) <- model_names
      
      clean_group <- gsub(" ", "", group_name)
    file_path <- paste0("figures/reg_", dv, "_", clean_group, ".tex")
    
    print(etable(
      models_list,
      fixef_sizes = TRUE,     
      fitstat = c("n", "r2", "wr2"), 
      tex = latex_format,
      dict = var_dict))} }

```

