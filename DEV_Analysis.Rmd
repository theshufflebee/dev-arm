---
title: "Armenia Drought Analysis"
output: 
  pdf_document:
    toc: true
    fig_caption: yes
    toc_depth: 3
    number_sections: true
header-includes:
   - \usepackage{booktabs}
   - \setcounter{secnumdepth}{3}
---
\newpage

# Setup
```{r library_setup, results=FALSE, warning=FALSE, message=FALSE, echo=TRUE}
rm(list=ls())
require(tinytex) #LaTeX
require(ggplot2) #plots
require(haven) #load data
require(dplyr) #data management
require(lubridate) #data dates management
require(zoo) #for lagging
require(jtools) #tables
require(huxtable) #tables
require(lmtest) #reg tests
require(data.table) #for data filtering
require(sandwich) #regression errors
require(readxl) #for reading excel data
require(tidyr) #data
require(tidyverse) #data
require(did) #DiD (support staggered treatment)
require(panelView) #for panel data treatment visibility
require(modelsummary) #for nice DiD tables
require(fixest) #TWFE regression

latex_format = FALSE

getwd()
setwd("...") 
set.seed(123)

```

# Data Load
```{r data}

load("final_data.Rdata")
load("final_data_quartiles.Rdata")
load("final_data_deciles.Rdata")
load("final_data_household.Rdata")

```

```{r, echo=FALSE, results='asis'}
cat("\\clearpage")
```

# Descriptive Evidence

## Graph 1
```{r district desc ev, message=FALSE, warning=FALSE}

# Prepare data
plot_data1 <- dataset %>%
  pivot_longer(cols = c(income, agric_income, agric_output, crops_output, poverty), 
    names_to = "metric",    
    values_to = "value" )

plot_data2 <- dataset %>%
  pivot_longer(cols = c(spei, share, agric_stress, Total_Rainfall, crops_land), 
    names_to = "metric",    
    values_to = "value" )

# Plot 
ggplot(plot_data1, aes(x = year, y = value, color = metric)) +
  geom_line(aes(group = metric)) + 
  geom_point(size = 0.5) +
  facet_grid(metric ~ district, scales = "free_y") + 
  labs(
    title = "x and SPEI Over Time by District",
    x = "Year",
    y = "Value (Scales Vary by Row)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(plot_data2, aes(x = year, y = value, color = metric)) +
  geom_line(aes(group = metric)) + 
  geom_point(size = 0.5) +
  facet_grid(metric ~ district, scales = "free_y") + 
  labs(
    title = "x and SPEI Over Time by District",
    x = "Year",
    y = "Value (Scales Vary by Row)") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1))

```

## Graph with Drought Dummy
```{r district desc ev agric drought, message=FALSE, warning=FALSE}


# Compute, for each years, the mean of agricultural output between districts
#  that experience drought vs no drought
agric_plot <- dataset %>%
  group_by(year, drought_dummy) %>%
  summarise(mean_agric = mean(agric_output, na.rm = TRUE), n_district = n()) 

ggplot(agric_plot, aes(x = year, y = mean_agric,
                      color = factor(drought_dummy), group = factor(drought_dummy))) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_color_manual(values = c("0" = "#0072B2", "1" = "#D55E00"),
                     labels = c("No Drought", "Drought")) +
  labs(x = "Year", y = "Mean Agricultural Output", color = "Drought Status",
       title = "Impact of Drought on Agricultural Output") +
  theme_minimal() +
  theme(legend.position = "top",
    axis.text.x = element_text(size = 5),
    axis.text.y = element_text(size = 5),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    strip.text = element_text(size = 4, face = "bold"))

```

## With Quartiles
```{r district desc ev w/ quartiles, message=FALSE, warning=FALSE}

# Data Prep
dataset_prepped_q <- dataset_quartiles %>%
  mutate(drought_status = factor(drought_dummy, 
                            levels = c(0, 1), 
                            labels = c("No Drought Event", "Drought Event")),
         income_quartile = factor(national_quartile, 
                            levels = c(1, 2, 3, 4), 
                            labels = c("Q1 (Poorest)", "Q2", "Q3", "Q4 (Richest)")))

# A1. Aggregate the data: Find the mean income for each year and quartile
plot1_data_q <- dataset_prepped_q %>%
  group_by(year, income_quartile) %>%
  summarize(avg_income = mean(income, na.rm = TRUE),
            avg_agr_income = mean(agric_income, na.rm = TRUE), .groups = 'drop') 


# A2. Create the plot q
ggplot(plot1_data_q, aes(x = year, y = avg_income, color = income_quartile, group = income_quartile)) +
  geom_line(linewidth = 1.2, alpha = 0.8) +
  geom_point(size = 2) +
  
  # --- Aesthetics & Labels ---
  scale_y_continuous(labels = scales::comma) + # Formats y-axis labels (e.g., 50,000)
  scale_color_brewer(palette = "RdYlBu", direction = -1) + 
  labs(
    title = "Average Income by Income Quartile Over Time",
    subtitle = "Averaged across all districts",
    x = "Year",
    y = "Average Annual Income",
    color = "Income Quartile") +
  theme_minimal() + theme(legend.position = "bottom")


# B1. Aggregate data: Mean income by year, quartile, AND drought status
plot2_data_q <- dataset_prepped_q %>%
  group_by(year, income_quartile, drought_status) %>%  
  summarize(avg_income = mean(income, na.rm = TRUE),
            avg_agr_income = mean(agric_income, na.rm = TRUE), .groups = 'drop')


# B2. Create the faceted plot q
ggplot(plot2_data_q, aes(x = year, y = avg_income, color = drought_status, group = drought_status)) +
  geom_line(linewidth = 1.1, alpha = 0.9) +
  
  # Create 4 separate plots, one for each 'income_quartile'
  facet_wrap(~ income_quartile, scales = "free_y") +
  
  # --- Aesthetics & Labels ---
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("No Drought Event" = "#0072B2", "Drought Event" = "#D55E00")) +
  labs(
    title = "Impact of Drought Events on Income, by Income Quartile",
    subtitle = "Average income trends faceted by income group",
    x = "Year",
    y = "Average Annual Income",
    color = "Drought Status") +
  theme_bw() + # A clean theme
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "grey90"), # Style the facet labels
    strip.text = element_text(face = "bold") )

```

```{r, echo=FALSE, results='asis'}
cat("\\clearpage")
```


# TWFE Regressions

## Data Subset Selection

Variables Units
* Armenian Dram (currency):
  + Income
  + Agriculture income
  + Agriculture output
  + Food consumption
* Tons (1000kg)
  + Grains harvest
  + Vegetables harvest
  + Fruits harvest
  + Potatoes harvest
* Tons per hectare (1000kg / 10000km2)
  + Grains output per field
  + Vegetables output per field
  + Fruits output per field
  + Potatoes output per field

```{r tfwedata selection, message=FALSE, warning=FALSE}

# Base case
twfe_data = dataset

# Taking logs for all dependent variables
twfe_data$income = log(twfe_data$income)
twfe_data$agric_income = log(twfe_data$agric_income)
twfe_data$agric_output = log(twfe_data$agric_output)
twfe_data$fdcons = log(twfe_data$fdcons)

twfe_data$grains_harvest = log(twfe_data$grains_harvest)
twfe_data$vegetables_harvest = log(twfe_data$vegetables_harvest)
twfe_data$fruits_harvest = log(twfe_data$fruits_harvest)
twfe_data$potatoes_harvest = log(twfe_data$potatoes_harvest)

twfe_data$output_per_field_grains = log(twfe_data$output_per_field_grains)
twfe_data$output_per_field_vegetables = log(twfe_data$output_per_field_vegetables)
twfe_data$output_per_field_fruits = log(twfe_data$output_per_field_fruits)
twfe_data$output_per_field_potatoes = log(twfe_data$output_per_field_potatoes)

# Excluding Yerevan
#twfe_data = subset(dataset, district != "Yerevan")

# Selecting majority-rural districts
#twfe_data = subset(dataset, urban < 0.5)

# Selecting the poorest income decile
#twfe_data = subset(dataset_deciles, national_decile == 1)

# Selecting the poorest income quartile
#twfe_data = subset(dataset_quartiles, national_quartile == 1)

# Selecting poorer regions
#twfe_data = subset(control, poverty > 0.3)

# Selecting a certain timeframe
#twfe_data = subset(control, year > 2015)

```

## Regression Loop
```{r reg_loop, message=FALSE,warning=FALSE,results='asis'}

# 1. Define dependent variables
dependent_vars <- c("income", "agric_income", "agric_output", "fdcons",
                    "grains_harvest", "vegetables_harvest", "fruits_harvest",
                    "potatoes_harvest", "output_per_field_grains", 
                    "output_per_field_vegetables", "output_per_field_fruits",
                    "output_per_field_potatoes")

# 2. Define independent variables as a list of groups
iv_groups <- list(
  "SPEI" = c(
    "spei",
    "spei + spei_lag1",
    "spei + spei_lag1 + spei_lag2"),
  "Share" = c(
    "share",
    "share + share_lag1",
    "share + share_lag1 + share_lag2"),
  "AgricStress" = c(
    "agric_stress",
    "agric_stress + agric_stress_lag1",
    "agric_stress + agric_stress_lag1 + agric_stress_lag2") )

# 3. Define names
model_names <- c(
  "Model 1: 0 Lags",
  "Model 2: 1 Lag",
  "Model 3: 2 Lags")

# 4. Loop for each dependent variable for each group of independent variables
for (dv in dependent_vars) {
  
  # Create a latex version of the dv name 
  dv_safe <- gsub("_", "\\\\_", dv)
  cat(paste0("\n\n\\subsection{Dependent Variable: ", dv_safe, "}\n\n"))

  for (group_name in names(iv_groups)) {
    cat(paste0("\n\n\\subsubsection{Regressed on: ", group_name, "}\n\n"))
    
    models_list <- list() 
    current_iv_formulas <- iv_groups[[group_name]] 
    
    for (i in 1:length(current_iv_formulas)) {
          fml_string <- sprintf("%s ~ %s | district + year", 
                            dv, 
                            current_iv_formulas[i])
      models_list[[i]] <- feols(
        as.formula(fml_string),
        data = twfe_data,
        cluster = ~ district) }
      names(models_list) <- model_names
    
    print(etable(
      models_list,
      # title argument removed
      fixef_sizes = TRUE,    
      fitstat = c("n", "r2"), 
      tex = latex_format)) } }

```

